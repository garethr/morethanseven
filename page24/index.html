<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      More than seven &middot; Gareth Rushgrove
    
  </title>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-435455-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
   <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=morethansevennet" id="_carbonads_js"></script>

   <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          More than seven
        </a>
      </h1>
      <p class="lead">Writing about code. Occasional other topics. Made by <a href="https://twitter.com/garethr">@garethr</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2009/09/06/automating-web-site-deployment-barcamp-brighton/">
        Automating web site deployment at Barcamp Brighton
      </a>
    </h1>

    <span class="post-date">06 Sep 2009</span>

    <p>On the first day at Barcamp Brighton this year I did a brief talk about getting started with automating deployment. I kept it nice and simple and didn&#8217;t focus on any specific technology or tool &#8211; just the general principles and pitfalls of doing anything manually. You can see the &#8220;slides on Slideshare&#8221;:</p>
<p><object style="margin:0px" width="425" height="355"><param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=automatingdeployment-090906054723-phpapp01&stripped_title=automating-web-site-deployment" /><param name="allowFullScreen" value="true"/><param name="allowScriptAccess" value="always"/><embed src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=automatingdeployment-090906054723-phpapp01&stripped_title=automating-web-site-deployment" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="355"></embed></object></p>
<p>As part of the presentation I even did a live demo and promised I&#8217;d upload the code I used. The following is an incredibly simple fabric file that has most the basic set of tasks. <a href="http://pypi.python.org/pypi/Fabric/">Fabric</a> is a python tool similar to capistrano in Ruby. I don&#8217;t really care whether you&#8217;re using make, ant, rake, capistrano or just plain shell scripts. Getting from not automating things to automating deployments is the important part &#8211; and it&#8217;s easier that you think.</p>
<script src="http://gist.github.com/181755.js"></script><p>The other part of the code example was a very basic apache virtualhost so just in case anyone needed that as well here it is:</p>
<pre>&amp;lt;VirtualHost *:80&amp;gt;
    ServerName sample.local
    DocumentRoot /srv/sample/releases/current
    &amp;lt;Directory /srv/sample/releases/current&amp;gt;
        Order deny,allow
        Allow from all
    &amp;lt;/Directory&amp;gt;
    ErrorLog /var/log/apache2/sample/error.log
    LogLevel warn
    CustomLog /var/log/apache2/sample/access.log combined
&amp;lt;/VirtualHost&amp;gt;</pre>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2009/08/31/another-chance-djugl/">
        Another chance to DJUGL
      </a>
    </h1>

    <span class="post-date">31 Aug 2009</span>

    <p><a href="http://djugl.eventwax.com/djugllondon-python"><span class="caps">DJUGL</span></a> is back, the <em>monthly</em> Django meetup in London. I think the last few times have been as much about useful Python stuff as just using Django, and this time it&#8217;s officially a bit more broad ranging. If you&#8217;re in or around London on the 24th September then come along.</p>
<p>You can get more information on <a href="http://twitter.com/londonpython">Twitter</a> or by following <a href="http://twitter.com/robertlofthouse/">Rob</a>. But expect a few short talks, some interesting conversations and maybe some beer with other like minded developers.</p>
<p>I&#8217;m going to be talking about automating deployment of Python web applications. If you follow me on Twitter you&#8217;ll have heard me rambling a little about some of what I&#8217;ve been up to, and some of the posts here give an insight into what I&#8217;ve been working on. But the short version is that several friends mentioned how difficult it could be to get a working Django application from a local machine to a production web server. And I though I better get down in script form my experiences of Django, <span class="caps">WSGI</span> applications and web server setup to make things easier.</p>
<p>I think this situation is partially caused by the success of the Django development server, and partially by people coming from a <span class="caps">PHP</span> background. In my <span class="caps">PHP</span> days I think I always wanted to know how Apache did it&#8217;s think, so long ago jumped into anything and everything in httpd.conf from loading modules to virtual hosts. But not everyone does the same, and <span class="caps">PHP</span> does make simple deployments easy enough that you might get away without doing so. Rails went through the same problems and seems to be coming out the other side. I&#8217;m hoping that Django and Python is soon to be in the same position, where basic deployment is just a given.</p>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2009/08/21/django-wsgi-deployment-solaris/">
        Django and WSGI deployment on Solaris
      </a>
    </h1>

    <span class="post-date">21 Aug 2009</span>

    <p>Now I&#8217;m generally an Ubuntu guy, but I&#8217;ve just had the need to setup some boxes running Solaris for Django and a handful of <span class="caps">WSGI</span> applications. I know my way around Ubuntu pretty well. I know all the packages I need to install and in what order. Hell, I even have all that scripted so I can just run a command and it works by magic. I&#8217;ll script the following steps if I can do when I get round to it but here, in one list, are the installation instructions for Apache, mod_wsgi, Mysql, MySQLdb, setuptools and memcached that worked for me on the latest version of <a href="http://www.opensolaris.com/">Open Solaris</a> (2009.06 at the time of writing).</p>
<p>First up I needed to install Apache and start the service running.</p>
<pre>pfexec pkg install SUNWapch22
svcadm enable http:apache22</pre>
<p>You should be able to test that&#8217;s running by hitting localhost on a browser running on the same box. Now for MySQL.</p>
<pre>pfexec pkg install SUNWmysql5
svcadm enable mysql:version_50</pre>
<p>This installs the mysql binary into /usr/mysql/5.0/bin/mysql on the system I&#8217;m working on. As I want to talk to the MySQL database server using Python I need to install MySQLdb.</p>
<pre>pfexec pkg install SUNWmysql-python
ln -s /usr/mysql/5.0/lib/mysql/libmysqlclient_r.so.15 /usr/lib/libmysqlclient_r.so.15</pre>
<p>This installs the library files into /usr/mysql/5.0/lib and Python doesn&#8217;t know were to find them. The above command links them into the more standard /usr/lib folder were Python will pick it up nicely.</p>
<p>I tend to use <a href="http://code.google.com/p/modwsgi/">mod_wsgi</a> for serving Python apps behind Apache,  however a mod_wsgi package isn&#8217;t part of the default package list. It is however available in the pending list so first you need to add that list of packages.</p>
<pre>pfexec pkg set-authority -O http://pkg.opensolaris.org/pending pending
pfexec pkg refresh
pfexec pkg install mod-wsgi</pre>

<p>This installs the module but you then need to tell Apache to load it. Add the following line to /etc/apache2/2.2/conf.d/modules-32.load or /etc/apache2/2.2/conf.d/modules-64.load depending on your architecture.</p>
<pre>LoadModule wsgi_module    libexec/mod_wsgi.so</pre>
<p>To get Apache to load that module you need to restart it like so:</p>
<pre>svcadm restart http:apache22</pre>
<p>I use <a href="http://pypi.python.org/pypi/pip">Pip</a> for installing Python code, but tend to install setuptools to make installing Pip easier. I don&#8217;t know if an up to date Pip package exists.</p>
<pre>pfexec pkg install python-setuptools</pre>
<p>This should leave you with easy_install on your path so installing Pip, then virtualenv should be a breeze.</p>
<p>As an added bonus I also installed memcached for some snappy caching.</p>
<pre>pfexec pkg install SUNWmemcached</pre>
<p>This won&#8217;t start up by default and needs a little configuration. The first command will launch you into a prompt where you can type the rest of the commands.</p>
<pre>svccfg
svc:&gt; select memcached
svc:/application/database/memcached&gt; setprop memcached/options=("-u" "nobody")
svc:/application/database/memcached&gt; quit</pre>
<p>Once you&#8217;d done that you should be able to start memcache on the standard port.</p>
<pre>svcadm refresh memcached
svcadm enable memcached</pre>
<p>Et voila. The internet helped massively on my quest to track down this information. Not all of the following links turned out to work for me but all of them led me in the right direction. Thanks everyone.</p>
<ul>
	<li>http://blogs.sun.com/quenelle/entry/jazz_guitar_and_rpath</li>
	<li>http://blogs.sun.com/natarajan/entry/installing_amp_stack_within_glassfish</li>
	<li>http://blogs.sun.com/overstre/entry/django_on_solaris10_with_the</li>
	<li>https://cds.sun.com/is-bin/<span class="caps">INTERSHOP</span>.enfinity/<span class="caps">WFS</span>/<span class="caps">CDS</span>-CDS_SMI-Site/en_US/-/<span class="caps">USD</span>/ViewProductDetail-Start?ProductRef=Web-Stack-1.5-<span class="caps">OTH</span>-G-F@CDS-CDS_SMI</li>
	<li>http://wiki.joyent.com/mod_wsgi</li>
	<li>http://textusers.com/wiki/AcceleratorDjango</li>
	<li>http://wiki.joyent.com/accelerators:kb:django</li>
	<li>http://www.b-list.org/weblog/2007/sep/04/django-accelerated/</li>
	<li>http://blogs.sun.com/natarajan/entry/getting_ruby_or_amp_apache</li>
	<li>http://blogs.sun.com/overstre/entry/opensolaris_with_mod_wsgi</li>
	<li>http://branesks.blogspot.com/2009/01/installing-modwsgi-on-opensolaris.html</li>
	<li>http://blogs.sun.com/overstre/entry/django_on_opensolaris</li>
	<li>http://code.google.com/p/modwsgi/wiki/InstallationOnSolaris</li>
	<li>http://groups.google.com/group/modwsgi/browse_thread/thread/7e2cc7ce366253cc</li>
	<li>http://blogs.sun.com/lr/entry/django_setup_mysql_python_opensolaris</li>
	<li>http://blogs.sun.com/trond/entry/memcached_in_solaris</li>
	<li>http://blog.hendrikvolkmer.de/2009/1/29/deploying-a-rails-application-on-opensolaris-with-passenger-aka-modrails/</li>
</ul>
<p>I&#8217;m not a Solaris admin. I&#8217;m not really a sysadmin at all, I just end up pretending to be one of late. Any experienced Solaris people with experience of these tools reading this I&#8217;d be grateful for any hints and tips. Hopefully this saves a few people from the head scratching I&#8217;ve been doing for the last few days.</p>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2009/08/15/your-own-pypi-server/">
        Your Own PyPi server
      </a>
    </h1>

    <span class="post-date">15 Aug 2009</span>

    <p>So one of the problems with using pip or easy_install as part of an automated deployment process is they rely on an internet connection. More than that, they rely on PyPi being up as it&#8217;s a centralised system, unlike all the apt package mirrors.</p>
<p>The best solution seems to be to host your own PyPi compliant server. Not only can you load all the third party modules you use onto it, but you could also upload any internal applications or libraries that you like. By running this on your local network you ensure your not dependent on pypi or an internet connection.</p>
<p>At the moment I&#8217;m playing with <a href="http://github.com/ask/chishop/tree/master">Chishop</a> which is a django application for maintaining a PyPi compatible server. Another alternative if that doesn&#8217;t work out is <a href="http://pypi.python.org/pypi/EggBasket/">EggBasket</a></p>
<p>To install from your own PyPi server you can specify the location of your Chishop instance with the -i flag.</p>
<pre>easy_install -i http://localhost:8000/ PACKAGE_NAME</pre>
<p>This will fall back to the PyPi server if it doesn&#8217;t find the relevant package. If you want to stop that behaviour and make sure you have a local package then you can limit the hosts with the -H flag like so.</p>
<pre>easy_install -H localhost:8000 -i http::/localhost:8000/ PACKAGE_NAME</pre>
<p>I&#8217;m not yet sure how to do this with pip, if someone wants to enlighten me in the comments then I&#8217;d be most grateful.</p>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2009/07/27/fabric-django-git-apache-mod-wsgi-virtualenv-and-p/">
        Fabric, Django, Git, Apache, mod_wsgi, virtualenv and pip deployment
      </a>
    </h1>

    <span class="post-date">27 Jul 2009</span>

    <p>I&#8217;ve been playing with automating Django deployments again, this time using <a href="http://fabfile.org/">Fabric</a>. I found a number of examples on the web but non of them quite fit the bill for me. I don&#8217;t like serving directly from a repository, I like to have either a package or tar I can use to say &#8220;that is what went to the server&#8221;. I also like having a quick rollback command as well as being able to deploy a particular version of the code when the need arises. I also wanted to go from a clean ubuntu install (plus <span class="caps">SSH</span>) to a running Django application in one command from the local development machine. The Apache side of things is nicely documented in <a href="http://gist.github.com/106077">this Gist</a> which made a good starting point.</p>
<p>I&#8217;m still missing a few things in this setup mind and at the moment you still have to setup your local machine yourself. I&#8217;m probably going to create a paster template and another fabfile to do that I think. The instructions are a little rough as well at the moment and I&#8217;ve left the database out of it as everyone has there own preference.</p>
<p>This particular fabric file makes setting up and deploying a django application much easier, but it does make a few assumptions. Namely that you&#8217;re using Git, Apache and mod_wsgi and your using Debian or Ubuntu. Also you should have  Django installed on your local machine and <span class="caps">SSH</span> installed on both the local machine and any servers you want to deploy to.</p>
<p><em>note that I&#8217;ve used the name project_name throughout this example. Replace this with whatever your project is called.</em></p>
<p>First step is to create your project locally:</p>
<pre>mkdir project_name
cd project_name
django-admin.py startproject project_name</pre>
<p>Now add a requirements file so pip knows to install Django. You&#8217;ll probably add other required modules in here later. Creat a file called requirements.txt and save it at the top level with the following contents:</p>
<pre>Django</pre>
<p>Then save this fabfile.py file in the top level directory which should give you:</p>
<pre>project_name
    fabfile.py
    requirements.txt
    project_name
        __init__.py
        manage.py
        settings.py
        urls.py</pre>
<p>You&#8217;ll need a <span class="caps">WSGI</span> file called project_name.wsgi, where project_name  is the name you gave to your django project. It will probably look like the following, depending on your specific paths and the location of your settings module</p>
<pre>import os
import sys
# put the Django project on sys.path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), "../")))
os.environ["DJANGO_SETTINGS_MODULE"] = "project_name.settings"
from django.core.handlers.wsgi import WSGIHandler
application = WSGIHandler()</pre>
<p>Last but not least you&#8217;ll want a virtualhost file for apache which looks  something like the following. Save this as project_name in the inner directory. You&#8217;ll want to change /path/to/project_name/ to the location on the remote server you intent to deploy to.</p>
<pre>&lt;VirtualHost *:80&gt;
        WSGIDaemonProcess project_name-production user=project_name group=project_name threads=10 python-path=/path/to/project_name/lib/python2.6/site-packages
        WSGIProcessGroup project_name-production
        WSGIScriptAlias / /path/to/project_name/releases/current/project_name/project_name.wsgi
        &lt;Directory /path/to/project_name/releases/current/project_name&gt;
            Order deny,allow
            Allow from all
        &lt;/Directory&gt;
        ErrorLog /var/log/apache2/error.log
        LogLevel warn
        CustomLog /var/log/apache2/access.log combined
&lt;/VirtualHost&gt;</pre>
<p>Now create a file called .gitignore, containing the following. This prevents the compiled python code being included in the repository and the archive we use for deployment.</p>
<pre>*.pyc</pre>
<p>You should now be ready to initialise a git repository in the top level project_name directory.</p>
<pre>git init
git add .gitignore project_name
git commit -m "Initial commit"</pre>
<p>All of that should leave you with</p>
<pre>project_name
    .git
    .gitignore
    requirements.txt
    fabfile.py
    project_name
        __init__.py
        project_name
        project_name.wsgi
        manage.py
        settings.py
        urls.py</pre>
<p>In reality you might prefer to keep your wsgi files and virtual host files elsewhere. The fabfile has a variable (config.virtualhost_path) for this case.  You&#8217;ll also want to set the hosts that you intend to deploy to (config.hosts) as well as the user (config.user).</p>
<p>The first task we&#8217;re interested in is called setup. It installs all the  required software on the remote machine, then deploys your code and restarts the webserver.</p>
<pre>fab local setup</pre>
<p>After you&#8217;ve made a few changes and commit them to the master Git branch you can run to deply the changes.</p>
<pre>fab local deploy</pre>
<p>If something is wrong then you can rollback to the previous version.</p>
<pre>fab local rollback</pre>
<p>Note that this only allows you to rollback to the release immediately before the latest one. If you want to pick a arbitrary release then you can use the following, where 20090727170527 is a timestamp for an existing release.</p>
<pre>fab local deploy_version:20090727170527</pre>
<p>If you want to ensure your tests run before you make a deployment then you can do the following.</p>
<pre>fab local test deploy</pre>
<p>The actual fabfile looks like this. I&#8217;ve uploaded a <a href="http://gist.github.com/156623">Gist of it</a>, along with the docs, so if you want to improve it please clone it.</p>
<pre># globals
config.project_name = 'project_name'
# environments
def local():
    "Use the local virtual server"
    config.hosts = ['172.16.142.130']
    config.path = '/path/to/project_name'
    config.user = 'garethr'
    config.virtualhost_path = "/"
# tasks
def test():
    "Run the test suite and bail out if it fails"
    local("cd $(project_name); python manage.py test", fail="abort")
def setup():
    """
    Setup a fresh virtualenv as well as a few useful directories, then run
    a full deployment
    """
    require('hosts', provided_by=[local])
    require('path')
    sudo('aptitude install -y python-setuptools')
    sudo('easy_install pip')
    sudo('pip install virtualenv')
    sudo('aptitude install -y apache2')
    sudo('aptitude install -y libapache2-mod-wsgi')
    # we want rid of the defult apache config
    sudo('cd /etc/apache2/sites-available/; a2dissite default;')
    run('mkdir -p $(path); cd $(path); virtualenv .;')
    run('cd $(path); mkdir releases; mkdir shared; mkdir packages;', fail='ignore')
    deploy()
def deploy():
    """
    Deploy the latest version of the site to the servers, install any
    required third party modules, install the virtual host and 
    then restart the webserver
    """
    require('hosts', provided_by=[local])
    require('path')
    import time
    config.release = time.strftime('%Y%m%d%H%M%S')
    upload_tar_from_git()
    install_requirements()
    install_site()
    symlink_current_release()
    migrate()
    restart_webserver()
def deploy_version(version):
    "Specify a specific version to be made live"
    require('hosts', provided_by=[local])
    require('path')
    config.version = version
    run('cd $(path); rm releases/previous; mv releases/current releases/previous;')
    run('cd $(path); ln -s $(version) releases/current')
    restart_webserver()
def rollback():
    """
    Limited rollback capability. Simple loads the previously current
    version of the code. Rolling back again will swap between the two.
    """
    require('hosts', provided_by=[local])
    require('path')
    run('cd $(path); mv releases/current releases/_previous;')
    run('cd $(path); mv releases/previous releases/current;')
    run('cd $(path); mv releases/_previous releases/previous;')
    restart_webserver()    
# Helpers. These are called by other functions rather than directly
def upload_tar_from_git():
    require('release', provided_by=[deploy, setup])
    "Create an archive from the current Git master branch and upload it"
    local('git archive --format=tar master | gzip &gt; $(release).tar.gz')
    run('mkdir $(path)/releases/$(release)')
    put('$(release).tar.gz', '$(path)/packages/')
    run('cd $(path)/releases/$(release) &amp;&amp; tar zxf ../../packages/$(release).tar.gz')
    local('rm $(release).tar.gz')
def install_site():
    "Add the virtualhost file to apache"
    require('release', provided_by=[deploy, setup])
    sudo('cd $(path)/releases/$(release); cp $(project_name)$(virtualhost_path)$(project_name) /etc/apache2/sites-available/')
    sudo('cd /etc/apache2/sites-available/; a2ensite $(project_name)') 
def install_requirements():
    "Install the required packages from the requirements file using pip"
    require('release', provided_by=[deploy, setup])
    run('cd $(path); pip install -E . -r ./releases/$(release)/requirements.txt')
def symlink_current_release():
    "Symlink our current release"
    require('release', provided_by=[deploy, setup])
    run('cd $(path); rm releases/previous; mv releases/current releases/previous;', fail='ignore')
    run('cd $(path); ln -s $(release) releases/current')
def migrate():
    "Update the database"
    require('project_name')
    run('cd $(path)/releases/current/$(project_name);  ../../../bin/python manage.py syncdb --noinput')
def restart_webserver():
    "Restart the web server"
    sudo('/etc/init.d/apache2 restart')
</pre>
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page25">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page23">Newer</a>
    
  
</div>
    </div>

  </body>
</html>
