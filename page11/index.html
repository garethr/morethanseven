<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      More than seven &middot; Gareth Rushgrove
    
  </title>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-435455-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
   <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=morethansevennet" id="_carbonads_js"></script>

   <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          More than seven
        </a>
      </h1>
      <p class="lead">Writing about code mainly. Occasional other topics. Made by <a href="https://twitter.com/garethr">@garethr</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2011/06/26/New-ganglia-web-interface-improvements/">
        New Ganglia Web Interface Improvements
      </a>
    </h1>

    <span class="post-date">26 Jun 2011</span>

    <p>So I&#8217;m a huge <a href="http://ganglia.sourceforge.net/">Ganglia</a> fan. It&#8217;s my go-to tool for standard low level metrics and for more ad-hoc higher level stuff as well. So I&#8217;m very happy to see the <a href="http://ganglia.info/?p=393">newly released</a> version of the Ganglia Web interface.</p>
<p>Here&#8217;s the old look and feel:</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRiZ8gEM" alt="Old Ganglia UI"/></p>
<p>And here&#8217;s the new version:</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRix6gEM" alt="New Ganglia UI"/></p>
<p>The first thing that stands out to me is the wide range of new options. We have a navigation bar with items like search, views, agregate graphs, events and mobile. And we have dynamic date ranges, and filtering and sorting options for metrics.</p>
<ul>
	<li>Search is what you&#8217;d expect. A search as you type facility for hosts and metrics, great if you have a large cluster and want to find something quickly.</li>
	<li>Views are interesting. Basically a way of putting together a specific set of metrics on one screen and linking to them, rather than always having to go via the node or grid overview.</li>
	<li>You could always create agregate graphs in Ganglia, but you had to delve into writing some <span class="caps">PHP</span> to get what you wanted. Not you can do certain types of graph on the fly, simply by specifying what you want.</li>
	<li>I&#8217;m cheating slightly here and using the very latest code rather than the 2.0.0 release. But it&#8217;s worth it for the Events feature. Events gives you the ability to record events like a deploy or a daily backup onto your graphs, immediately making some types of diagnosis easier. More about how I&#8217;m using this when I finish automating it.</li>
	<li>Gnaglia always worked OK on a mobile device mainly because all you really wanted was the graphs. The new mobile UI however just makes navigating much easier. It&#8217;s not yet doing device detection and automatically redirecting my iphone to that view which would be nice but it&#8217;s definately a good addition.</li>
	<li>Combined with views, automatic rotation shows a series of graphs, one every 30 seconds. Particularly useful for big screen dashboards, in fact I&#8217;ve built this exact feature before more than once before.</li>
</ul>
<p>I&#8217;ve concentrated here on the new visual features, but the new UI also contains <span class="caps">CSV</span> and <span class="caps">JSON</span> output for all metrics as well as a much easier <span class="caps">JSON</span> based approach to defining custom metrics. The amount of stuff in this release is huge. Massive thanks to the folks behind all the new features, in particular <a href="http://vuksan.com/">Vladimir Vuksan</a>.</p>
<p>Ganglia is such a staple that I&#8217;m used to just using whatever is in the latest distro provided packages. When it comes to the web UI however I&#8217;m going to make an exception from now on. Not only can you run the new UI in parallel with the old, deployment is simply copying a directory into place (It&#8217;s easy to forget just how simple <span class="caps">PHP</span> deployment is sometimes). If you&#8217;re already using Ganglia spend a few minutes installing the new UI. If you&#8217;ve rejected Ganglia previously because it didn&#8217;t have one feature or another then now is the time to look again.</p>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2011/06/09/Logging-django-performance/">
        Logging Django Performance
      </a>
    </h1>

    <span class="post-date">09 Jun 2011</span>

    <p>I&#8217;ve been doing some basic performance profiling work with Ruby on Rails recently and one tool I found very useful was the <a href="https://github.com/wvanbergen/request-log-analyzer">request log analyzer</a>. It&#8217;s a relatively simple command line application that you can point at the Rails application log files and it outputs lots of information in agregate. So information about request duration averages or about <span class="caps">SQL</span> queries run. When working on a recent Django project I wanted a tool to do the same thing and ended up writing timelog.</p>
<p>I did a bit of research to see if I could find something similar. Here are a few other interesting tools that didn&#8217;t quite do what I wanted:</p>
<ul>
	<li><a href="https://github.com/jmoiron/django-slow-log">Django Slow Log</a> &#8211; This logs things like memory and load averages</li>
	<li><a href="https://github.com/lamby/django-dumpslow">Django Dump Slow</a> &#8211; Similar but designed to just log slow requests rather than everything, also needs a Redis backend</li>
	<li><a href="https://github.com/jbalogh/zamboni/blob/master/apps/amo/middleware.py#L162">Zamboni Middleware</a> &#8211; This is very similar to what I wanted, but it&#8217;s not a separate module and I didn&#8217;t find anything to analyse the results</li>
</ul>
<p>Timelog is very similar to the middleware in Zamboni, the only real difference being I&#8217;m using the new logging support in Django 1.3. More interesting is the bundled management command which will output something like:</p>
<pre>
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
| view                     | method | status | count | minimum | maximum | mean  | stdev           |
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
| boxes.viewsBoxDetailView | GET    | 200    | 9430  | 0.14    | 0.28    | 0.21  | 0.0700037118541 |
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
| boxes.viewsBoxListView   | GET    | 200    | 66010 | 0.17    | 0.28    | 0.232 | 0.0455415351076 |
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
| django.views.staticserve | GET    | 200    | 61295 | 0.00    | 0.02    | 0.007 | 0.0060574669888 |
+--------------------------+--------+--------+-------+---------+---------+-------+-----------------+
</pre>
<p>At the moment I&#8217;ve not done any real benchmarking or optimisation of the script, but it will chew through a 300,000 line (20MB) log file in under 20s on my aging macbook.</p>
<p>The code for Timelog is on github at <a href="http://github.com/garethr/django-timelog">github.com/garethr/django-timelog</a> and I&#8217;ve uploaded to PyPi as well at <a href="http://pypi.python.org/pypi/django-timelog">pypi.com/django-timelog</a>. You can install it with the usual tools like pip:</p>
<pre>pip install django-timelog</pre>
<p>Once installed you need to do a little configuration to get things working. First add the middleware to your MIDDLEWARE_CLASSES in your settings file.</p>
<pre>
MIDDLEWARE_CLASSES = (
  'timelog.middleware.TimeLogMiddleware',
</pre>
<p>Next add timelog to your INSTALLED_APPS list. This is purely for the management command discovery.</p>
<pre>
INSTALLED_APPS = (
  'timelog',
</pre>
<p>Then configure the logger you want to use. This really depends on what you want to do, the django 1.3 logging setup is pretty powerful. Here&#8217;s how I&#8217;ve got logging setup as an example:</p>
<pre>
TIMELOG_LOG = '/path/to/logs/timelog.log'

LOGGING = {
  'version': 1,
  'formatters': {
    'plain': {
      'format': '%(asctime)s %(message)s'},
    },
  'handlers': {
    'timelog': {
      'level': 'DEBUG',
      'class': 'logging.handlers.RotatingFileHandler',
      'filename': TIMELOG_LOG,
      'maxBytes': 1024 * 1024 * 5,  # 5 MB
      'backupCount': 5,
      'formatter': 'plain',
    },
  },
  'loggers': {
    'timelog.middleware': {
      'handlers': ['timelog'],
      'level': 'DEBUG',
      'propogate': False,
     }
  }
}
</pre>
<p>In order for the analyser script to work correctly you&#8217;ll need to use the plain formatter and to register a handler for the timelog.middleware logger.</p>
<p>With that all configured try hitting your application a few times. You should see a log file created at the location specified in TIMELOG_LOG. Fill that up with a few lines and then run the analyze_timelog management command:</p>
<pre>python manage.py analyze_timelog</pre>
<p>This should output something similar to the above table but with your timings and views. The management command currently allows you to point the analyzer at a different file say from a backup, or a file you&#8217;ve pulled down from production but want to run the command locally. I&#8217;ll likely add some filters as time permits for things like not showing all views or showing only views between a given date range.</p>
<p>The above table showing the view function is good for big picture trends, but if you want to dig down into a particular path then you can pass an argument to not reverse the path:</p>
<pre>python manage.py analyze_timelog --noreverse</pre>
<p>This should give you something more like:</p>
<pre>
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| view                             | method | status | count | minimum | maximum | mean  | stdev            |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| /assets/css/main.css             | GET    | 200    | 61295 | 0.00    | 0.02    | 0.007 | 0.0060574669888  |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| / bob                            | GET    | 404    | 4715  | 0.01    | 0.01    | 0.01  | 0.0              |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| /                                | GET    | 200    | 66010 | 0.17    | 0.28    | 0.232 | 0.0455415351076  |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| /__debug__/m/css/toolbar.min.css | GET    | 304    | 4715  | 0.00    | 0.00    | 0.0   | 0.0              |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
| /14/                             | GET    | 200    | 9430  | 0.14    | 0.28    | 0.21  | 0.0700037118541  |
+----------------------------------+--------+--------+-------+---------+---------+-------+------------------+
</pre>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2011/06/04/Getting-http-headers-right/">
        Debugging HTTP Headers with RedBot
      </a>
    </h1>

    <span class="post-date">04 Jun 2011</span>

    <p>I&#8217;ve been using the <a href="http://www.vagrantbox.es">Vagrantbox.es</a> site as a bit of a playground recently and I&#8217;ve been meaning to blog about some of the overengineering I&#8217;ve been doing. Here&#8217;s a smaller starter.</p>
<p>Getting the headers returned by your web server correct is both easy to do and easy to forget about. Unless you go actively looking for headers with curl or similar you&#8217;ll probably miss them, and even then will you spot an incorrect header by eye? <a href="http://redbot.org">RedBot</a> is an excellent online tool that not only shows you the headers but makes recommendations about what might be missing, invalid or things you haven&#8217;t considered.</p>
<p>For instance the <a href="http://redbot.org/?uri=http%3A%2F%2Fwww.vagrantbox.es">RedBot results for vagrantbox.es</a> look like this:</p>
<p><img src="http://image-host.appspot.com/i/img?id=agppbWFnZS1ob3N0cg0LEgVJbWFnZRjJ4gEM" alt="Debugging information from Redbot"/></p>
<p>Or at least they do now after a few tweaks to my nginx configuration. In particular I&#8217;ve added</p>
<pre>add_header Vary Accept-Encoding;</pre>
<p>I&#8217;d assumed that enabling gzip compression with gzip_vary would have set this automatically and never checked. The way RedBot provides a checklist of recommendations is very handy.</p>
<p>As well as checking the page itself you can also check all the assets associated with a page by adding a query string argument. For instance here is the <a href="http://redbot.org/?descend=True&amp;uri=http://www.vagrantbox.es">assets view for Vagrantbox.es</a>. RedBot also provides a <a href="http://redbot.org/?id=o5GXZe&amp;descend=True&amp;format=har"><span class="caps">JSON</span> encoded version of the result</a> which might be useful in a CI system. If you&#8217;d rather run your own instance of the software you can, the code can be found on github at <a href="http://mnot.github.com/redbot/">mnot.github.com/redbot/</a>. It currently doesn&#8217;t work with <span class="caps">HTTPS</span> resources but that&#8217;s about the only thing I&#8217;d like to see added.</p>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2011/05/15/Python-on-cloudfoundry/">
        Python On Cloudfoundry
      </a>
    </h1>

    <span class="post-date">15 May 2011</span>

    <p>For those that haven&#8217;t yet had a look <a href="http://cloudfoundry.com/">Cloudfoundry</a> from VMware is two things, one of which is nice, one of which is very cool indeed:</p>
<ul>
	<li>On one hand it&#8217;s a platform as a service, allowing you to easily deploy Ruby, Java and Node.js applications to <a href="http://cloudfoundry.com/">cloudfoundry.com</a>.</li>
	<li>On the other hand it&#8217;s an <a href="http://cloudfoundry.org/">open source project</a> with all the code on <a href="http://github.com/cloudfoundry">Github</a> allowing you to run the entire stack wherever you like.</li>
</ul>
<p>I&#8217;m pretty interested in the latter. Its <span class="caps">API</span> could in theory become a defacto standard for application and service buildouts, in the same way as we&#8217;re seeing the EC2 <span class="caps">API</span> expand outside <span class="caps">AWS</span> for managing infrastructure (and arguably how we&#8217;re using Chef and Puppet for managing the things installed on that infrastructure). The really interesting bit is the fact it&#8217;s all open source. Not only does that mean you can run it on your own infrastructure (including as I&#8217;m doing on a virtual machine on my laptop), but it&#8217;s also designed so new services (like Redis, MySQL, RabbitMQ), new runtimes (like Ruby 1.8, RUby 1.9, Java) and new frameworks (like Rails, Sinatra, Spring) can be added easily.</p>
<p>I&#8217;m running vcap on a <a href="http://vagrantup.com">vagrant</a> managed VirtualBox instance, but you could install it anywhere you like. I used <a href="https://github.com/auser/cloudfoundry-quickstart">these chef recipes</a> to get everything installed. I ran into an issue with the mysql service not starting correctly that <a href="https://github.com/auser/cloudfoundry-quickstart/pull/2">I fixed</a> and I needed to manually install chef into the rvm gemset part way through the install, but the recipes pretty much just worked.</p>
<p>Looking for an excuse to have a route through the vcap code I decided to see if I could add rudimentary support for Python applications. After a day of noodling around I&#8217;ve forked the code and sent a few pull requests back with it basically working. This required changes to the <a href="https://github.com/cloudfoundry/vmc/pull/18">vmc client</a>, to the <a href="https://github.com/cloudfoundry/vcap/pull/57">vcap service</a> and like all good open source contributions to the <a href="https://github.com/cloudfoundry/vcap-tests/pull/4">test suite</a>.</p>
<p>Thanks hugely to existing pull requests (mainly the one&#8217;s for <a href="https://github.com/cloudfoundry/vcap/pull/25">adding <span class="caps">PHP</span> support</a>) it&#8217;s not taken long at all. The Sinatra and Rails support which shipped with the first release from VMWare supports using Bundler to define gem dependencies that can be pulled in at deploy time. It shouldn&#8217;t be too much effort I&#8217;m hoping to do the same for using pip and virtualenv for each deployed python application. I think I can also see how to support python3 and how to add django as a supported framework.</p>
<p>I had huge fun, but you might not at this early stage in the project. I&#8217;m relatively happy with reading and writing Ruby, futzing with rvm, debugging installation woes and hunting down service configuration problems. The best tool for working out what was happening was generally tailing the logs in /tmp/vcap-run/ and finding the code that wrote a given message. If you just want something to work I&#8217;d wait a little while, if you like the sound of the above it&#8217;s a pretty nice codebase to play around in. I&#8217;d love to eventually see some official contributor documentation and some hints and tips on things like running the tests. At the moment flicking through reported issues and pull requests on GitHub is the best place to start.</p>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2011/05/08/Vagrant-plugin-for-interacting-with-vagrantboxes/">
        Vagrant Plugin For Interacting With Vagrantbox.es
      </a>
    </h1>

    <span class="post-date">08 May 2011</span>

    <p>After <a href="http://www.jedi.be/blog">Patrick</a> released <a href="https://github.com/jedi4ever/sahara/">Sahara</a>, a nifty extension for the <a href="http://vagrantup.com">Vagrant</a> command line tool, I&#8217;ve been meaning to put together a similar extension for interacting with the growing list of base boxes on <a href="http://www.vagrantbox.es">vagrantbox.es</a>.</p>
<p>After a bit of hacking this morning I&#8217;ve just pushed out an initial release of the <a href="https://rubygems.org/gems/vagrantboxes">vagrantboxes gem</a> and you can find the <a href="https://github.com/garethr/ruby-vagrantboxes">source code and some documentation on GitHub</a>.</p>
<p>The extensions adds a vagrantboxes namespace to the vagrant command line tool which provides a few useful commands. Specifically you can list all the available boxes, do text searches, show the full details of a box and most handily of all add a box that takes your fancy to your local base box store, all without having to worry about the URLs of the boxes if you don&#8217;t want to.</p>
<p>Here&#8217;s an example of a simple search:</p>
<pre>&gt;&gt; vagrant vagrantboxes search centos
3    centos 5.5                http://dl.dropbox.com/u/15307300/vagrant-0.7-centos-64-base.box
6    opscode centos 5          http://opscode-vagrant-boxes.s3.amazonaws.com/centos5-gems.box
7    opscode ubuntu 10.04      http://opscode-vagrant-boxes.s3.amazonaws.com/ubuntu10.04-gems.box
9    puppet centos 5.5 64      http://puppetlabs.s3.amazonaws.com/pub/centos5_64.box
10   puppet centos 4 64        http://puppetlabs.s3.amazonaws.com/pub/centos4_64.box
21   centos 5.6 32             http://yum.mnxsolutions.com/vagrant/centos_56_32.box</pre>
<p>And another quick example, this time of show printing the full description. In the future I might look to store more structured metadata and make this more useful.</p>
<pre>&gt;&gt; vagrant vagrantboxes show 18
puppet debian lenny 64
http://puppetlabs.s3.amazonaws.com/pub/debian_lenny_64.box

Debian Lucid 64 bit vagrant box. Puppet 2.6.6 installed and ready to provision using the Puppet provisioner in Vagrant.

For good sample modules, try the jeffmccune-motd and jeffmccune-mockbuild modules posted to http://forge.puppetlabs.com/

Created by Ken Barber, ken@puppetlabs.com</pre>
<p>This proved a good excuse to delve into the Vagrant source code which is pretty readable for the most part once you understand the libraries it&#8217;s build upon. It&#8217;s simple enough to extend for adding commands like this too, which bodes well for other more useful additions in the future.</p>
<p>If anyone has any problems with this extensions do let me know. Error handling currently consists of returning blank output rather than sensible error codes or messages, and as I&#8217;ve yet to add a small test suite so their might (will) be a few bugs lying around. I&#8217;ll try and make it better behaved in the next week or two but reasoned it&#8217;s useful straight away.</p>
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page12">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page10">Newer</a>
    
  
</div>
    </div>

  </body>
</html>
