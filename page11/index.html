<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      More than seven &middot; Gareth Rushgrove
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
   <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=morethansevennet" id="_carbonads_js"></script>

   <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          More than seven
        </a>
      </h1>
      <p class="lead">Writing about code mainly. Occasional other topics. Made by <a href="https://twitter.com/garethr">@garethr</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/cron/deployment/puppet/chef/whenever/2011/05/07/Version-control-and-deployment-of-cron-jobs/">
        Version Control And Deployment Of Cron Jobs
      </a>
    </h1>

    <span class="post-date">07 May 2011</span>

    <p>A recent question on Twitter prompted me to write a quick blog post about managing cron jobs. As more and more people want to automate provisioning and deployment of web applications some, maybe previously manually managed, items come into the fold.</p>
<p>Cron jobs are interesting because you may prefer to see them as part of the infrastructure (like apache or mysql) or as part of your application code. I think both are valid, sometimes at the same time. For instance you might have a cron job which deals with scheduled database backups. All that requires is the database and the script to be present. At other times your cron jobs might require your entire application stack. For instance a rake task which uses a Rails application model, or a django management command.</p>
<h2>Configuration Management and Cron</h2>
<p>Both <a href="http://opscode.com/chef/">Chef</a> and <a href="http://puppetlabs.com/puppet/">Puppet</a> provide a cron resource type. This is particularly handy for things like database backup scripts or ganglia gmetric scripts. You probably want these scripts and cron jobs to be installed on machines that have the related software installed, and you&#8217;re probably already describing this in your Chef recipes or Puppet manifests. If you&#8217;re not already using one of these tools using them to manage just your cron jobs is a nice way of starting out.</p>
<p>Using the <a href="http://docs.puppetlabs.com/references/latest/type.html#cron">Puppet Cron Type</a> looks like this:</p>
<pre><code>cron { command:
  command =&gt; "/usr/local/sbin/command",
  hour =&gt; 2,
  minute =&gt; 0
}</code></pre>
<p>And the equivalent <a href="http://wiki.opscode.com/display/chef/Resources#Resources-Cron">Chef Reasource</a> looks like:</p>
<pre><code>cron "describe your job" do
  hour "2"
  minute "0"
  command "/usr/local/sbin/command"
end</code></pre>
<p>The important part is that by describing your cron jobs in code you can then version control them easily, and both Chef and Puppet have mechanisms to push these jobs out to be installed by the relevant hosts. With cron jobs you might not want all your machines to be running the same jobs for instance.</p>
<h2>Using Whenever</h2>
<p>An alternative, or complimentary, approach to versioning and deploying cron jobs would be to tie it in with your application code. This makes sense when those jobs are tightly coupled to your application, for instance rails specific rake tasks or django management commands. <a href="https://github.com/javan/whenever">Whenever</a> is a tool I&#8217;ve been using recently that makes this pretty simple. You describe your cron jobs in a file called schedule.rb like so:</p>
<pre><code>every 3.hours do
  command "/usr/local/sbin/command"
end</code></pre>
<p>And then running the provided whenever command line application will generate a working crontab. Whenever ships with capistrano integration and some useful shortcuts for running rake tasks or accessing Ruby code, but it&#8217;s simple to write your own command shortcuts without having to write ruby code too.</p>
<h2>Other Approaches</h2>
<p>I have seen some tools which replace cron completely, but I&#8217;ve never liked that idea much. Cron works pretty well, and is clever enough to deal with things like daylight saving time and leap years inteligently if needed. I know other folks who are centralising all regular jobs into something like Jenkins. I can see advantages to that, although I&#8217;ve yet to find a really nice way of automating this outside the gui interface or manually modifying configuration files.</p>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/cucumber-nagios/fpm/packaging/2011/04/29/Creating-a-cucumber-nagios-package-with-fpm/">
        Creating A Cucumber Nagios Package With Fpm
      </a>
    </h1>

    <span class="post-date">29 Apr 2011</span>

    <p>I&#8217;ve written <a href="http://morethanseven.net/2011/01/16/Why-developers-should-care-about-system-packages.html">before</a> about why I like System Packages, but even I&#8217;ll admit that the barriers to creating them mean I don&#8217;t use them for everything. <a href="https://github.com/jordansissel/fpm"><span class="caps">FPM</span></a> however is making it much easier, to the point where I&#8217;m starting to create a few packages I can reuse on projects. I thought a write up of how I&#8217;m doing that for <a href="http://cucumber-nagios.org/">Cucumber-Nagios</a> might be useful.</p>
<p>For those that haven&#8217;t seen it yet, <span class="caps">FPM</span> (or Effing Package Management) is a tool that helps you build packages, like RPMs and DEBs, quickly. It can take in gems, python packages, node.js npm files or just plain directories and make files and from that create you one or more system packages. Lets have a look at a full example with a Ruby gem.I really like using cucumber-nagios, whatever platform or language I happen to be using at the time. I have a number of Django projects for instance with cucumber-nagios checks, so being able to not worry about most of the Ruby install is useful.</p>
<p>In order to use <span class="caps">FPM</span> you&#8217;ll need to install it. It&#8217;s available as a Ruby gem so lets start there. I&#8217;m not going to delve into setting up a Ruby Gems environment as it&#8217;s annoying and covered for most platforms elsehere on the internet.</p>
<pre><code>gem install fpm</code></pre>
<p>First off lets install the cucumber-nagios gem, along with all it&#8217;s dependencies, into a local folder on my build machine. This might be a virtual machine or a separate machine in your cluster. It should be running the same OS as the intended production machines however. The following examples are from Ubuntu, but it&#8217;s much the same for <span class="caps">RPM</span> based distros.</p>
<pre><code>gem install --no-ri --no-rdoc --install-dir ~/tmp/gems cucumber-nagios</code></pre>
<p>Cucumber-nagios has a large number of dependencies, so we&#8217;re going to need to create packages for all of those too. <span class="caps">FPM</span> will cleverly deal with maintaining the specified dependencies thought. We&#8217;ll use find to do this quickly, and then instruct <span class="caps">FPM</span> to convert from a gem to a deb. You could obviously do this line by line if you prefer.</p>
<pre><code>find ~/tmp/gems/cache -name '*.gem' | xargs -rn1 fpm -s gem -t deb -a all</code></pre>
<p>That should leave us with lots of new .deb files that we can have a closer look at:</p>
<pre><code>dpkg --info rubygem-cucumber-nagios_0.9.0_i686.deb
dpkg -c rubygem-cucumber-nagios_0.9.0_i686.deb</code></pre>
<p>If you already have a private apt repository set up then just upload these packages and away you go. I&#8217;d like to use apt for installing them so I can leave it to manage all the dependencies easily. If not then I&#8217;ll show you briefly how to create a local file system repo, it&#8217;s not much more work to create a shared repo available over <span class="caps">HTTP</span>.</p>
<p>First create a directory to store our packages and move our newly created .deb files into it. You&#8217;ll need to be able to execute some of these commands as root but given the topic I&#8217;m assuming you&#8217;ll be able to deal with that.</p>
<pre><code>mkdir /usr/local/repo
cp *.all.deb /usr/local/repo</code></pre>
<p>For the next part you&#8217;ll need to install the dpkg development tools, and then create a file that can be read by apt when it&#8217;s looking for packages it can install.</p>
<pre><code>apt-get install dpkg-dev
dpkg-scanpackages /usr/local/repo /dev/null | gzip -9c &gt; /usr/local/repo/Packages.gz</code></pre>
<p>Now add your new package repo to your apt sources and update your package cache.</p>
<pre><code>/etc/apt/sources.list
deb file:/usr/local/repo ./
apt-get update</code></pre>
<p>At this point everything should be up and running. Let&#8217;s do a search in our repo:</p>
<pre><code>apt-cache search rubygem-
rubygem-amqp - AMQP client implementation in Ruby/EventMachine
rubygem-builder - Builders for MarkUp.
rubygem-bundler - The best way to manage your application's dependencies
rubygem-cucumber - cucumber-0.10.2
rubygem-cucumber-nagios - Systems testing plugin for Nagios using Cucumber.
rubygem-diff-lcs - Provides a list of changes that represent the difference between two sequenced collections.
rubygem-eventmachine - Ruby/EventMachine library
rubygem-extlib - Support library for DataMapper and Merb
rubygem-gherkin - gherkin-2.3.6
rubygem-highline - HighLine is a high-level command-line IO library.
rubygem-json - JSON Implementation for Ruby
rubygem-mechanize - The Mechanize library is used for automating interaction with websites
rubygem-net-ssh - Net::SSH: a pure-Ruby implementation of the SSH2 client protocol.
rubygem-nokogiri - Nokogiri (鋸) is an HTML, XML, SAX, and Reader parser
rubygem-rack - a modular Ruby webserver interface
rubygem-rack-test - Simple testing API built on Rack
rubygem-rspec - rspec-2.5.0
rubygem-rspec-core - rspec-core-2.5.1
rubygem-rspec-expectations - rspec-expectations-2.5.0
rubygem-rspec-mocks - rspec-mocks-2.5.0
rubygem-templater - Templater has the ability to both copy files from A to B and also to render templates using ERB
rubygem-term-ansicolor - Ruby library that colors strings using ANSI escape sequences
rubygem-webrat - Ruby Acceptance Testing for Web applications</code></pre>
<p>And finally lets install cucumber-nagios from our shiny new package.</p>
<pre><code>apt-get install rubygem-cucumber-nagios</code></pre>
<p>If everything has worked out you should be able to run the cucumber-nagios-gen command to create a new project. Note that the path may be different, and in the case of debian based distros the gem bin path is not on the Path.</p>
<pre><code>/usr/lib/ruby/gems/1.8/bin/cucumber-nagios-gen project test
Generating with project generator:
     [ADDED]  .gitignore
     [ADDED]  .bzrignore
     [ADDED]  Gemfile
     [ADDED]  README
     [ADDED]  features/steps
     [ADDED]  features/support</code></pre>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/devopsweekly/2011/04/17/Devops-weekly-archive/">
        Devops Weekly Archive
      </a>
    </h1>

    <span class="post-date">17 Apr 2011</span>

    <p>Since I launched it back in November my <a href="http://devopsweekly.com">Devops Weekly</a> email has been pretty well received I think. Folks on twitter seem to like it, as do a few people I&#8217;ve met at recent events who have said nice things. One thing a few people have been after though is an online archive, either because email just doesn&#8217;t work for them or more often because they missed out on the earlier issues.</p>
<p>With a little time this weekend and the help of <a href="https://github.com/mojombo/jekyll">Jekyll</a> I&#8217;ve just added the seventeen iss§ues to date to the new <a href="http://devopsweekly.com/archive">Devops Weekly archive</a>. I&#8217;d have liked to do something a bit more useful, maybe introduce per link tags or a nifty search feature, but I&#8217;m pretty busy at present and reason this should serve the main purpose of getting these links online.</p>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/theguardian/vagrant/2011/04/02/Vagrant-at-the-guardian/">
        Vagrant At The Guardian
      </a>
    </h1>

    <span class="post-date">02 Apr 2011</span>

    <p>As recent blog posts on here make clear, I&#8217;m a big fan of <a href="http://vagrantup.com">Vagrant</a>. And when <a href="http://www.brunton-spall.co.uk/">Michael</a> asked if I&#8217;d fancy talking to some of his colleagues at The Guardian about how I use it I really couldn&#8217;t say no.</p>
<p>I gave a short talk, running through the following slides, and running a few demos showing creating, destroying and provisioning new machines.</p>
<p><object id="__sse7492432" width="595" height="497"> <param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=vagrant-110402104037-phpapp01&rel=0&stripped_title=vagrant-and-configuration-management&userName=garethr" /> <param name="allowFullScreen" value="true"/> <param name="allowScriptAccess" value="always"/> <embed name="__sse7492432" src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=vagrant-110402104037-phpapp01&rel=0&stripped_title=vagrant-and-configuration-management&userName=garethr" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="595" height="497"></embed> </object></p>
<p>More interesting I thought were the questions and conversations that followed. We talked a little about how Vagrant might fit into a continuous integration setup. Another aspect some of the systems folk took to was how flexible the network configuration was and whether they might be able to use this to more effectively test firewall configurations well before the final push into a production environment. It&#8217;s not something I&#8217;ve been doing but it sounds feasable and useful in some organisations. If anyone is doing interesting things with Vagrants network config I&#8217;d be interested to know.</p>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/ganglia/metrics/cambridgegeeknight/2011/04/02/Collecting-metrics-with-ganglia-and-friends/">
        Collecting Metrics With Ganglia And Friends
      </a>
    </h1>

    <span class="post-date">02 Apr 2011</span>

    <p>I had the pleasure of speaking at <a href="http://cambridgegeeknights.net/">Cambridge Geek Night</a> on Monday again, the topic of conversation being using Ganglia to collect more than just base systems metrics.</p>
<p><object id="__sse7492405" width="595" height="497"> <param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=metricswithganglia-110402103441-phpapp01&rel=0&stripped_title=metrics-with-ganglia&userName=garethr" /> <param name="allowFullScreen" value="true"/> <param name="allowScriptAccess" value="always"/> <embed name="__sse7492405" src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=metricswithganglia-110402103441-phpapp01&rel=0&stripped_title=metrics-with-ganglia&userName=garethr" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="595" height="497"></embed> </object></p>
<p>The audience of web developers, the odd sysadmin and business folk seemed to enjoy it and we had lots of time for questions at the end. The main point I tried to get across was that Ganglia makes a great platform for ad-hoc metrics gathering due to the ability to just throw values at it and get time series graphs without any extra configuration.</p>
<p>The slides include a few bits of code I&#8217;ve been using that I&#8217;ll throw onto GitHub as a proper project when I get the time. These are very simple Python servers, one which allows for sending metrics information over <span class="caps">HTTP</span>, the other using <span class="caps">TCP</span> instead. Both really handy for getting more people to add hooks into applications.</p>
  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page12">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page10">Newer</a>
    
  
</div>
    </div>

  </body>
</html>
