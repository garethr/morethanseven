<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      More than seven &middot; Gareth Rushgrove
    
  </title>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-435455-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
   <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=morethansevennet" id="_carbonads_js"></script>

   <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          More than seven
        </a>
      </h1>
      <p class="lead">Writing about code. Occasional other topics. Made by <a href="https://twitter.com/garethr">@garethr</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/10/28/docker-puppet-shared-volumes/">
        Docker, Puppet and shared volumes
      </a>
    </h1>

    <span class="post-date">28 Oct 2014</span>

    <p>During one of the openspace sessions at Devopsdays we talked about docker and configuration management,
and one of the things we touched on was using dockers shared volumes support. This is easier to explain
with an example.</p>

<p>First, lets create a docker image to run puppet. I&#39;m also installing r10k for managing third party
modules.</p>

<h2>Docker</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">FROM ubuntu:trusty

RUN apt-get update -q
RUN apt-get install -qy wget
RUN wget http://apt.puppetlabs.com/puppetlabs-release-trusty.deb
RUN dpkg -i puppetlabs-release-trusty.deb
RUN apt-get update

RUN apt-get install -y puppet ruby1.9.3 build-essential git-core
RUN echo &quot;gem: --no-ri --no-rdoc&quot; &gt; ~/.gemrc
RUN gem install r10k
</code></pre></div>
<p>Lets build that and tag it locally. Feel free to use whatever name you like here.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">docker build -t garethr/puppet .
</code></pre></div>
<p>Lets now use that image as a base for another image.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">FROM garethr/puppet

RUN mkdir /etc/shared
ADD Puppetfile /
RUN r10k puppetfile check
RUN r10k puppetfile install
ADD init.pp /
CMD [&quot;puppet&quot;, &quot;apply&quot;, &quot;--modulepath=/modules&quot;, &quot;/init.pp&quot;,&quot;--verbose&quot;, &quot;--show_diff&quot;]
</code></pre></div>
<p>This image will be used to create containers that we intend to run. Here we&#39;re including a
Puppetfile (a list of module dependencies) and then running r10k to download those dependencies.
Finally we add a simple puppetfile (this would likely be an entire manifests directory in most cases).
The final line means that when we run a container based on this image it will run puppet and then exit.</p>

<p>Again lets build the image and tag it.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">docker build -t garethr/puppetshared .
</code></pre></div>
<p>Just as a demo, here&#39;s a sample <code>Puppetfile</code> which includes the puppetlabs stdlib module.</p>

<h2>Puppet</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">mod &#39;puppetlabs/stdlib&#39;
</code></pre></div>
<p>And again as an example here&#39;s a simple puppet <code>init.pp</code> file. All we&#39;re doing is creating a file
at a specific location.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">file { &#39;/etc/shared/client&#39;:
  ensure =&gt; directory,
}

file { &#39;/etc/shared/client/apache.conf&#39;:
  ensure  =&gt; present,
  content =&gt; &quot;not a real config file&quot;,
}
</code></pre></div>
<h2>Fig</h2>

<p><a href="http://fig.sh">Fig</a> is a tool to declare container types in a text file, and then run and manage
them from a simple CLI. We could do all this with straigh docker calls too.</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">master</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">garethr/puppetshared</span>
  <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/etc/shared:/etc/shared:rw</span>

<span class="l-Scalar-Plain">client</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu:trusty</span>
  <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/etc/shared/client:/etc/:ro</span>
  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&#39;/bin/sh</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">&quot;while</span><span class="nv"> </span><span class="s">true;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">world;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1;</span><span class="nv"> </span><span class="s">done&quot;&#39;</span>
</code></pre></div>
<p>The important part of the above is the volumes lines. What we&#39;re doing here is:</p>

<ul>
<li>Sharing the <code>/etc/shared</code> directory on the host with the container called master. The container will be able to write to the host filesystem.</li>
<li>Sharing a subdirectory of of <code>/etc/shared</code> with the client container. The client can only read this information.</li>
</ul>

<p>Note the client container here isn&#39;t running Puppet. Here it&#39;s just running sleep in a loop to simulate a long running process like
your custom application.</p>

<p>Let&#39;s run the master. Note that this will run puppet and then exit. But with the above manifest it will create
a config file on the host.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">fig run master
</code></pre></div>
<p>Then run the client. This won&#39;t exit and should just print <code>hello world</code> to stdout.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">fig run client
</code></pre></div>
<p>Docker 1.3 adds the handy exec command, which allows for one-off commands to be executed within a running container.
Lets use that to see our new config file.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">docker exec puppetshared_client_run_1 cat /etc/apache.conf
</code></pre></div>
<p>This should output the contents of the file we created by running the master container.</p>

<h2>Why?</h2>

<p>This is obviously a very simple example but I think it&#39;s interesting for a few reasons.</p>

<ul>
<li>We have completely separated our code (in the container) from the configuration</li>
<li>We get to use familiar tools for managing the configuration in a familiar way</li>
</ul>

<p>It also raises a few problems:</p>

<ul>
<li>The host needs to know what types of container are going to run on it, in order to have the correct configuration. If you&#39;re using <a href="https://forge.puppetlabs.com/garethr/docker">Puppet module</a> then this is simple enough to solve.</li>
<li>The host ends up with all of the configuration for all the containers in one place, you could also do things with encrypting the data and having the relevant keys in one image and not others. Given how if you&#39;re on the host you own the container anyway this isn&#39;t as odd as it sounds.</li>
<li>We&#39;re just demonstrating files here, but if we change our manifest and rerun the puppet container then we change the config files. But depending on the application it  won&#39;t pick that up unless we restart it or create a new container.</li>
</ul>

<p>Given enough time I may try build a reference implementation using this approach, anyone with ideas about that let me know.</p>

<p>This post was inspired by a conversation with <a href="https://twitter.com/kelseyhightower">Kelsey</a> and <a href="http://twitter.com/botchagalupe">John</a>, thanks guys.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/10/12/using-puppet-with-key-value-config-stores/">
        Using Puppet with key/value config stores
      </a>
    </h1>

    <span class="post-date">12 Oct 2014</span>

    <p>I like the central idea behind storing configuration in something like
<a href="https://github.com/coreos/etcd">Etcd</a> rather than lots of files on lots
of disks, but a few challenges still remain. Things that spring to mind
are:</p>

<ul>
<li>Are all your passwords now available to all of your nodes?</li>
<li>How do I know when configuration changed and who changed it?</li>
</ul>

<p>I&#39;ll leave the first of those for today (although have a look at
<a href="http://www.conjur.net/">Conjur</a> as one approach to this). For the second,
I&#39;m quite fond of plain text, pull requests and a well tested deployment
pipeline. Before Etcd (or <a href="http://www.consul.io/">Consul</a> or similar) you
would probably have values in Hiera or Data Bags or similar and inject them
into files on hosts using your configuration management tool of choice. So
lets just do the same with our new-fangled distributed configuration store.</p>
<div class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="na">key_value_config</span> <span class="p">{</span> <span class="s">&#39;/foo&#39;</span><span class="p">:</span>
  <span class="na">ensure</span>   <span class="o">=&gt;</span> <span class="k">present</span><span class="p">,</span>
  <span class="na">provider</span> <span class="o">=&gt;</span> <span class="na">etcd</span><span class="p">,</span>
  <span class="na">value</span>    <span class="o">=&gt;</span> <span class="s">&#39;bar&#39;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>Say you wanted to switch over to using Consul instead? Just switch the provider.</p>
<div class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="na">key_value_config</span> <span class="p">{</span> <span class="s">&#39;/foo&#39;</span><span class="p">:</span>
  <span class="na">ensure</span>   <span class="o">=&gt;</span> <span class="k">present</span><span class="p">,</span>
  <span class="na">provider</span> <span class="o">=&gt;</span> <span class="na">consul</span><span class="p">,</span>
  <span class="na">value</span>    <span class="o">=&gt;</span> <span class="s">&#39;bar&#39;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>You&#39;d probably move all of that out into something like hiera, and then generate
the above resources, but you get the idea.</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">etcd_values</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">foo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bar</span>
</code></pre></div>
<p>The above is implemented in a very simple
<a href="https://github.com/garethr/garethr-key_value_config">proof of concept Puppet module</a>.
Anyone with any feedback please do let me know.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/07/20/leaving-gds-never-easy/">
        Leaving GDS never easy
      </a>
    </h1>

    <span class="post-date">20 Jul 2014</span>

    <p><em>The following is the email I sent to lots of my colleagues at the 
<a href="https://gds.blog.gov.uk/">Government Digital Service</a> last week.</em></p>

<p>So, after 3 rather exciting years I&#39;ve decided to leave GDS.</p>

<p>That&#39;s surprisingly difficult to write if I&#39;m honest.</p>

<p>I was part of the team that built and shipped the beta of <a href="https://www.gov.uk">GOV.UK</a>.
Since then I&#39;ve worked across half of what has become GDS, equally
helping and frustrating (then hopefully helping) lots of you. I&#39;ve
done a great deal and learnt even more, as well as collected arcane
knowledge about government infosec and the dark arts of procurement
along the way. I&#39;ve done, and helped others do, work I wouldn&#39;t even
have thought possible (or maybe likely is the right word?) when I
started.</p>

<p>So why leave? For all the other things I do I&#39;m basically a tool
builder. So I&#39;m going off to work for <a href="http://puppetlabs.com">Puppet Labs</a> to build
infrastructure tools that don&#39;t suck. That sort of pretty specific
work is something that <em>should</em> be done outside government in my
opinion. I&#39;m a pretty firm believer in &quot;government should only do what
only government can do&quot; (<a href="https://www.gov.uk/design-principles#second">design principle number 2</a> for those that
haven&#39;t memorised them yet). And if I&#39;m honest, focusing on something
smaller than fixing a country&#39;s civic infrastructure is appealing for
now.</p>

<p>I&#39;ll let you in on a secret; I didn&#39;t join what became GDS because of
the GOV.UK project. I joined to work with friends I&#39;d not yet had the
chance to work with and to see the inside of a growing organisation
from the start. I remember <a href="http://twitter.com/tomskitomski">Tom Loosemore</a> promising me we&#39;d be 200
people in 3 years! As far as anyone knows we&#39;re 650+ people. That&#39;s
about a person a day for 2 years. I&#39;m absolutely not saying that came
without a cost, but for me being part of that that was part of the
point - so I can be a little accepting with hindsight.</p>

<p>For me, apart from all the short term things (side-note: this job now
has me thinking Â£10million is a small amount of money and 2 years is a
small amount of time) there is one big mission:</p>

<blockquote>
<p>Make government a sustainable part of the UK tech community</p>
</blockquote>

<p>That means in 10 years time experienced tech people from across the
country, as well as people straight from university, choosing to work
for government. Not just for some abstract and personal reason (though
that&#39;s fine too), but because it&#39;s a a genuinely interesting place to
work. That one&#39;s on us.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/06/23/using-owasp-zap-from-the-command-line/">
        Using OWASP ZAP from the command line
      </a>
    </h1>

    <span class="post-date">23 Jun 2014</span>

    <p>I&#39;m a big fan of <a href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project">OWASP ZAP</a> or
the Zed Attack Proxy. It&#39;s suprisingly user friendly and nicely pulls of
it&#39;s aim of being useful to developers as well as more hardcore penetration testers.</p>

<p>One of the features I&#39;m particularly fond of is the aforementioned
proxy. Basically it can act as a transparent HTTP proxy, recording the
traffic, and then analyse that to conduct various active security tests;
looking for XSS issues or directory traversal vulnerabilities for
instance. The simplest way of seeding the ZAP with something to analyse is using
the simple inbuilt spider.</p>

<p>So far, so good. Unfortunately ZAP isn&#39;t designed to be used from the
command line. It&#39;s either a thick client, or it&#39;s a proxy with a simple
API. Enter <a href="https://github.com/garethr/zapr">Zapr</a>.</p>

<p>Zapr is a pretty simple wrapper around the ZAP API (using the
<a href="https://github.com/vpereira/owasp_zap">owasp_zap</a> library under the
hood). All it does is:</p>

<ul>
<li>Launch the proxy in headless mode</li>
<li>Trigger the spider</li>
<li>Launch various attacks against the collected URLs</li>
<li>Print out the results</li>
</ul>

<p>This is fairly limited, in that a spider isn&#39;t going to work
particularly well for a mor interactive application, but it&#39;s a farily good
starting point. I may add different seed methods in the future (or would
happily accept pull requests). Usage wise it&#39;s as simple as:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">zapr --summary http://localhost:3000/
</code></pre></div>
<p>That will print you out something like the following, assuming it finds
an issue.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">+-----------------------------------+----------+----------------------------------------+
| Alert                             | Risk     | URL                                    |
+-----------------------------------+----------+----------------------------------------+
| Cross Site Scripting (Reflected)  | High     |http://localhost:3000/forgot_password   |
+-----------------------------------+----------+----------------------------------------+
</code></pre></div>
<p>The above alert is taken from a <a href="https://github.com/garethr/zapr-example">simple example</a>,
using the <a href="https://github.com/OWASP/railsgoat">RailsGoat</a> vulnerable web
application as a scape goat. You can see the resulting output from
<a href="https://travis-ci.org/garethr/zapr-example">Travis running the tests</a>.</p>

<p>Zapr is a bit of a proof of concept so it&#39;s not particularly robust or
well tested. Depending on usage and interest I may tidy it up and extend
it, or I may leave it as a useful experiment and try and finally get ZAP
support into <a href="http://gauntlt.org">Gauntlt</a>, only time will tell.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/04/25/consul/">
        Consul, DNS and Dnsmasq
      </a>
    </h1>

    <span class="post-date">25 Apr 2014</span>

    <p>While at <a href="http://craft-conf.com/2014">Craft</a> I decided to have a quick look at
<a href="http://www.consul.io/">Consul</a>, a new service discovery framework with
a few intersting features. One of the main selling points is a DNS
interface with a nice API. The <a href="http://www.consul.io/intro/index.html">Introduction</a>
shows how to use this via the dig command line tool, but how do you use
a custom internal DNS server without modifying all your applications?
One answer to this question is
<a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">Dnsmasq</a>.</p>

<p>I&#39;m not explaining Consul here, the above mentioned introduction does a
good job of stepping through the setup. The following assumes you have
installed and started consul.</p>

<h2>Installation and configuration</h2>

<p>I&#39;m running these examples on an Ubuntu 14.04 machine, but dnsmasq
should be available and packaged for lots of different operating
systems.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">apt-get install dnsmasq
</code></pre></div>
<p>Once installed we can create a very simple configuration.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s2">&quot;server=/consul/127.0.0.1#8600&quot;</span> &gt; /etc/dnsmasq.d/10-consul
</code></pre></div>
<p>All we&#39;re doing here is specifying that DNS requests for consul services
are to be dealt with by the DNS server at 127.0.0.1 on port 8600. Unless
you&#39;ve changed the consul defaults this should work.</p>

<p>Just in case you prefer Puppet their is already a handy
<a href="https://github.com/saz/puppet-dnsmasq">dnsmasq</a> module. The resulting
puppet code then looks like this.</p>
<div class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="k">include</span> <span class="na">dnsmasq</span>
<span class="na">dnsmasq</span><span class="p">::</span><span class="na">conf</span> <span class="p">{</span> <span class="s">&#39;consul&#39;</span><span class="p">:</span>
  <span class="na">ensure</span>  <span class="o">=&gt;</span> <span class="k">present</span><span class="p">,</span>
  <span class="na">content</span> <span class="o">=&gt;</span> <span class="s">&#39;server=/consul/127.0.0.1#8600&#39;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<h2>Usage</h2>

<p>The examples from the main documentation specify a custom DNS server for
dig like so:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">dig @127.0.0.1 -p <span class="m">8600</span> web.service.consul
</code></pre></div>
<p>With Dnsmasq installed and configured as above you should just be able
to do the following:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">dig web.service.consul
</code></pre></div>
<p>And now any of your existing applications will be able to use your
consul instance for service discovery via DNS.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page4">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page2">Newer</a>
    
  
</div>
    </div>

  </body>
</html>
