<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      More than seven &middot; Gareth Rushgrove
    
  </title>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-435455-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
   <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=morethansevennet" id="_carbonads_js"></script>

   <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          More than seven
        </a>
      </h1>
      <p class="lead">Writing about code. Occasional other topics. Made by <a href="https://twitter.com/garethr">@garethr</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/20/puppet-module-skeleton-updates/">
        Update to Puppet Module Skeleton
      </a>
    </h1>

    <span class="post-date">20 Aug 2015</span>

    <p>Being on holiday last week meant I had a little time for some gardening
of open source projects and I decided to update
<a href="https://www.github.com/garethr/puppet-module-skeleton">puppet-module-skeleton</a>
with some new opinions.</p>

<p>The skeleton is a replacement for the default module skeleton that ships
with Puppet and is used by puppet module generate. Unlike the default
skeleton this one is super-opinionated. It comes bundled with lots of
testing tools, suggestions for documentation, integration with <a href="http://travis-ci.org">Travis
CI</a>, module coverage reports and more.</p>

<p>Updates in the latest version include:</p>

<ul>
<li>Support for Puppet 4 paths</li>
<li>The addition of Rubocop, which enforces parts of the Ruby style guide</li>
<li>Adding a number of Puppet Lint plugins</li>
<li>Allow installing various Puppet versions during integration tests</li>
</ul>

<p>I also fixed a few reported bugs and extended the test matrix to test
across a range of Puppet and Ruby combinations.</p>

<p>The skeleton is intended to help people with a basic understanding of
Puppet write better modules, without having to setup everything
themselves. You don’t have to agree with all the options to make use of
the skeleton as it’s simple enough to delete a few files once you
generate your new module. But a working out-of-the-box beaker install,
and the ability to automatically run unit tests when files change are
patterns worth adopting for most module developers I think.</p>

<p>If anyone has any suggestions for extra tools, or changes to the
skeleton itself, let me know.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/05/19/information-security-reading-list/">
        Information Security Reading List
      </a>
    </h1>

    <span class="post-date">19 May 2015</span>

    <p>I read quite a bit (probably a book a week or so) and one of the topics
I&#39;ve been reading on for a while is information security. In a recent
conversation someone asked for some book suggestions, so I thought I&#39;d
write that up in a blog post rather than an email.</p>

<p>Most of this list isn&#39;t particularly technical. It&#39;s not a developers
list of software engineering tomes. If you&#39;re a developer or operator
then I&#39;d recommend reading some of the more policy or journalistic
pieces as well for context. And if you&#39;re just interested in the topic
but nor particularly technical I&#39;d skip the security engineering
suggestions.</p>

<p>Note that I make no claims about this being a particularly balanced
list, it&#39;s biased towards what I find interesting to read. Hopefully
you&#39;ll find it interesting too.</p>

<h2>Journalism</h2>

<p>Understanding why Information Security is important tends to require
some context. The following books provide that, with detailed real-world
stories of criminal and government activities.</p>

<ul>
<li><a href="http://www.amazon.co.uk/The-Dark-Net-Jamie-Bartlett/dp/0434023159">The Dark Net</a> - Jamie Bartlett - an excellent personal tale of
investigating the hidden side of the internet.</li>
<li><a href="http://www.amazon.co.uk/Spam-Nation-Organized-Cybercrime-Epidemic-ebook/dp/B00L5QGBL0">Spam Nation</a> - Brian Krebs - everything you wanted to know about how
and why Spam works.</li>
<li><a href="http://www.amazon.co.uk/Countdown-Zero-Day-Stuxnet-Digital/dp/077043617X">Countdown to Zero Day</a> - Kim Zetter - a detailed and fast paced
description of the Stuxnet attack, and it&#39;s implications.</li>
<li><a href="http://www.amazon.co.uk/Future-Crimes-Everything-Connected-Vulnerable/dp/0385539002">Future Crimes</a> - Marc Goodman - a focus on the criminal
possibilities of the modern internet and the internet of things.</li>
<li><a href="http://www.amazon.co.uk/Worm-The-First-Digital-World/dp/1611855845">Worm</a> - Mark Bowden - similar to the excellent tale of Stuxnet
above, this is the story of Conficker and how it was discovered</li>
</ul>

<h1>Policy and context</h1>

<p>These books are focused more on government policy and nation state
threats, and the debate about the rules of war and the internet.</p>

<ul>
<li><a href="http://www.amazon.co.uk/Cyber-War-Threat-National-Security/dp/0061962244">Cyber War</a> - Richard Clarke - probably the best description of what
cyber war is and isn&#39;t, and some of the geopolitical problems
emerging.</li>
<li><a href="http://www.amazon.co.uk/Cyber-War-Will-Take-Place/dp/1849042802">Cyber War Will Not Take Place</a> - Thomas Rid - a good counter to the
above book, with lots more detailed discussion of policy and definition.</li>
<li><a href="http://www.amazon.co.uk/Inside-Cyber-Warfare-Mapping-Underworld/dp/1449310044">Inside Cyber Warfare</a> - Jeffrey Carr - really just a run through of
current threats, especially organised crime.</li>
</ul>

<h1>Security engineering</h1>

<ul>
<li><a href="http://www.cl.cam.ac.uk/%7Erja14/book.html">Security Engineering</a> - Ross Anderson - highly technical and quite
epic, but definitely the best security engineering book around.</li>
<li><a href="http://www.amazon.co.uk/Threat-Modeling-Designing-Adam-Shostack/dp/1118809998">Threat Modelling</a> - Adam Shostack - details descriptions of how and
why to conduct threat moddelling, with lots of examples.</li>
<li><a href="http://www.amazon.co.uk/Data-Driven-Security-Visualization-Dashboards/dp/1118793722">Data Driven Security</a> - Jay Jacobs and Bob Rudis - nice examples,
including code samples, of applying data and statistics tools and
practices to security problems.</li>
<li><a href="http://www.amazon.co.uk/Cloud-Security-Privacy-Enterprise-Perspective/dp/0596802765">Cloud Security and Privacy</a> - Tim Mather, Subra Kumaraswamy, Shahed
Latif - a good book to read for anyone working in AWS, Azure or similar.
Good discussion of concerns and compliance approaches in third party
environments.</li>
<li><a href="http://www.amazon.co.uk/The-Tangled-Web-Securing-Applications/dp/1593273886">The Tangled Web</a> - Michal Zalewski - everything you ever wanted to
know about the browser security model</li>
<li><a href="http://www.amazon.co.uk/Silence-Wire-Passive-Reconnaissance-Indirect/dp/1593270461">Silence on the Wire</a> - Michal Zalewski - described as a field guide
to passive reconnaissance and indirect attacks. Good for starting to
think about non-obvious security threats</li>
</ul>

<h1>On my reading list</h1>

<p>I&#39;ve not read these books yet so can&#39;t recommend them as such, but they
both look good additions to the list above.</p>

<ul>
<li><a href="http://www.amazon.co.uk/Data-Goliath-Bruce-Schneier/dp/0393244814">Data and Goliath</a> - Bruce Schneier - a look at the large scale data
collection programmes of governments and their implications for
everyone.</li>
<li><a href="http://www.amazon.co.uk/Black-Code-Ronald-J-Deibert/dp/0771025351">Black Code</a> - Ronald J. Deibert - the story of the Citizen Lab
and it&#39;s front line cyber researchers</li>
</ul>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/05/09/acceptance-testing-mirageos/">
        Acceptance testing MirageOS installs
      </a>
    </h1>

    <span class="post-date">09 May 2015</span>

    <p>I&#39;m pretty interested in <a href="http://openmirage.org/">MirageOS</a> at the
moment. Partly because I find the idea behind unikernels interesting and
partly because I keep bumping into the nice folks <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/">OCaml
Labs</a> in Cambridge.</p>

<p>In order to write and build your MirageOS unikernel application you need
an OCaml development environment. Although this is
<a href="http://openmirage.org/wiki/install">documented</a> I wanted something a
little more repeatable. I also found and reported a few bugs in the
documentation which got me thinking about acceptance testing. I&#39;m not
(yet) an OCaml programmer, but infrastructure automation and testing I
can do.</p>

<h2>Into Puppet</h2>

<p>I started out writing a Puppet module to install and manage everything,
which is now available on
<a href="https://github.com/garethr/garethr-mirageos">GitHub</a> and on the
<a href="https://forge.puppetlabs.com/garethr/mirageos">Forge</a>.</p>

<p>This lets you do something like the following, and have a fully working
MirageOS setup on Ubuntu 12.04 or 14.04.</p>
<div class="highlight"><pre><code class="language-puppet" data-lang="puppet"><span class="k">class</span> <span class="p">{</span> <span class="s">&#39;mirageos&#39;</span><span class="p">:</span>
  <span class="k">user</span>      <span class="o">=&gt;</span> <span class="s">&#39;vagrant&#39;</span><span class="p">,</span>
  <span class="na">opam_root</span> <span class="o">=&gt;</span> <span class="s">&#39;/home/vagrant/.opam&#39;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>Given time, inclination or pull requests I&#39;ll add support for other
operating systems in the future.</p>

<h2>But how do you know it works?</h2>

<p>The module has a small unit test suite, but it&#39;s nice to know test the
actual running of Puppet and installation of the software. For this I&#39;ve
used <a href="http://kitchen.ci/">Test Kitchen</a> and
<a href="http://serverspec.org/">ServerSpec</a>. This allows for spinning up 2
virtual machines (one for each supported operating system), applying the
Puppet manifest and then making some assertions:</p>

<p><noscript><pre>400: Invalid request
</pre></noscript><script src="https://gist.github.com/a8d090b5d7f7a190f7d9.js"> </script></p>

<p>The above is simply checking whether certain packages are installed, the
PPA is setup correctly and whether <code>mirage</code> and <code>opam</code> can be executed
cleanly.</p>

<h2>Can it produce a working unikernel?</h2>

<p>The above tells us whether the installation worked, but not whether the
resulting software allows us to build MirageOS unikernels. For this I
used <a href="https://github.com/sstephenson/bats">Bats</a> running in the same
Test Kitchen setup.</p>

<p><noscript><pre>400: Invalid request
</pre></noscript><script src="https://gist.github.com/191c4c0676b471f9b986.js"> </script></p>

<p>The above configures and builds a simple HTTP server unikernel, and then
checks that when run it returns the expected response on the correct
port.</p>

<h2>Conclusion</h2>

<p>I like the separation of concerns above. I can use the Puppet code
without the test code, or even swap the Puppet code out for a shell
script if I wanted. I could also run the serverspec tests anywhere I
want to check state, which is the reason for separating those tests from
the one&#39;s building and running a unikernel. Overall the tool chain for ad-hoc
infrastructure testing (quick mention of
<a href="http://infrataster.net/">Infrataster</a> too) is really quite powerful and
approachable. I&#39;d love to see more software ship with a user-facing test
suite for people to verify their installation works.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/01/02/automating-windows-development-environments/">
        Automating windows development environments
      </a>
    </h1>

    <span class="post-date">02 Jan 2015</span>

    <p>My job at Puppet Labs has given me an excuse to take a closer look at
the advancements in Windows automation, in particular <a href="https://chocolatey.org/">Chocolatey</a>
and <a href="http://boxstarter.org/">BoxStarter</a>. The following is very much a work
in progress but it&#39;s hopefully useful for a few things:</p>

<ul>
<li>If like me you&#39;ve mainly been doing non-Windows development for a
while it&#39;s interesting to see what is possible</li>
<li>If you&#39;re starting out with infrastructure development on Windows the
following could be a good starting place</li>
<li>if you&#39;re an experienced Windows pro then you can let me know of any
improvements</li>
</ul>

<p>All that&#39;s needed is to run the following from a CMD or Powershell
prompt on a new Windows machine (you can also visit the URL in Internet
Explorer if you prefer).</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">START http://boxstarter.org/package/nr/url?https://gist.githubusercontent.com/garethr/a1838aa68355a0766de4/raw/d92b41ee9dcad68c079d24c64bac7d1d27cf37c7/garethr.ps1
</code></pre></div>
<p>This launches BoxStarter, which executes the following code:</p>

<p><noscript><pre>400: Invalid request
</pre></noscript><script src="https://gist.github.com/a1838aa68355a0766de4.js"> </script></p>

<p>This takes a while as it runs Windows update and repeatedly reboots the
machine. But once completed you&#39;ll have the listed software installed
and configured on a newly up-to-date Windows machine.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/10/28/docker-puppet-shared-volumes/">
        Docker, Puppet and shared volumes
      </a>
    </h1>

    <span class="post-date">28 Oct 2014</span>

    <p>During one of the openspace sessions at Devopsdays we talked about docker and configuration management,
and one of the things we touched on was using dockers shared volumes support. This is easier to explain
with an example.</p>

<p>First, lets create a docker image to run puppet. I&#39;m also installing r10k for managing third party
modules.</p>

<h2>Docker</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">FROM ubuntu:trusty

RUN apt-get update -q
RUN apt-get install -qy wget
RUN wget http://apt.puppetlabs.com/puppetlabs-release-trusty.deb
RUN dpkg -i puppetlabs-release-trusty.deb
RUN apt-get update

RUN apt-get install -y puppet ruby1.9.3 build-essential git-core
RUN echo &quot;gem: --no-ri --no-rdoc&quot; &gt; ~/.gemrc
RUN gem install r10k
</code></pre></div>
<p>Lets build that and tag it locally. Feel free to use whatever name you like here.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">docker build -t garethr/puppet .
</code></pre></div>
<p>Lets now use that image as a base for another image.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">FROM garethr/puppet

RUN mkdir /etc/shared
ADD Puppetfile /
RUN r10k puppetfile check
RUN r10k puppetfile install
ADD init.pp /
CMD [&quot;puppet&quot;, &quot;apply&quot;, &quot;--modulepath=/modules&quot;, &quot;/init.pp&quot;,&quot;--verbose&quot;, &quot;--show_diff&quot;]
</code></pre></div>
<p>This image will be used to create containers that we intend to run. Here we&#39;re including a
Puppetfile (a list of module dependencies) and then running r10k to download those dependencies.
Finally we add a simple puppetfile (this would likely be an entire manifests directory in most cases).
The final line means that when we run a container based on this image it will run puppet and then exit.</p>

<p>Again lets build the image and tag it.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">docker build -t garethr/puppetshared .
</code></pre></div>
<p>Just as a demo, here&#39;s a sample <code>Puppetfile</code> which includes the puppetlabs stdlib module.</p>

<h2>Puppet</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">mod &#39;puppetlabs/stdlib&#39;
</code></pre></div>
<p>And again as an example here&#39;s a simple puppet <code>init.pp</code> file. All we&#39;re doing is creating a file
at a specific location.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">file { &#39;/etc/shared/client&#39;:
  ensure =&gt; directory,
}

file { &#39;/etc/shared/client/apache.conf&#39;:
  ensure  =&gt; present,
  content =&gt; &quot;not a real config file&quot;,
}
</code></pre></div>
<h2>Fig</h2>

<p><a href="http://fig.sh">Fig</a> is a tool to declare container types in a text file, and then run and manage
them from a simple CLI. We could do all this with straigh docker calls too.</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">master</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">garethr/puppetshared</span>
  <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/etc/shared:/etc/shared:rw</span>

<span class="l-Scalar-Plain">client</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu:trusty</span>
  <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/etc/shared/client:/etc/:ro</span>
  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&#39;/bin/sh</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">&quot;while</span><span class="nv"> </span><span class="s">true;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">world;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1;</span><span class="nv"> </span><span class="s">done&quot;&#39;</span>
</code></pre></div>
<p>The important part of the above is the volumes lines. What we&#39;re doing here is:</p>

<ul>
<li>Sharing the <code>/etc/shared</code> directory on the host with the container called master. The container will be able to write to the host filesystem.</li>
<li>Sharing a subdirectory of of <code>/etc/shared</code> with the client container. The client can only read this information.</li>
</ul>

<p>Note the client container here isn&#39;t running Puppet. Here it&#39;s just running sleep in a loop to simulate a long running process like
your custom application.</p>

<p>Let&#39;s run the master. Note that this will run puppet and then exit. But with the above manifest it will create
a config file on the host.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">fig run master
</code></pre></div>
<p>Then run the client. This won&#39;t exit and should just print <code>hello world</code> to stdout.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">fig run client
</code></pre></div>
<p>Docker 1.3 adds the handy exec command, which allows for one-off commands to be executed within a running container.
Lets use that to see our new config file.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">docker exec puppetshared_client_run_1 cat /etc/apache.conf
</code></pre></div>
<p>This should output the contents of the file we created by running the master container.</p>

<h2>Why?</h2>

<p>This is obviously a very simple example but I think it&#39;s interesting for a few reasons.</p>

<ul>
<li>We have completely separated our code (in the container) from the configuration</li>
<li>We get to use familiar tools for managing the configuration in a familiar way</li>
</ul>

<p>It also raises a few problems:</p>

<ul>
<li>The host needs to know what types of container are going to run on it, in order to have the correct configuration. If you&#39;re using <a href="https://forge.puppetlabs.com/garethr/docker">Puppet module</a> then this is simple enough to solve.</li>
<li>The host ends up with all of the configuration for all the containers in one place, you could also do things with encrypting the data and having the relevant keys in one image and not others. Given how if you&#39;re on the host you own the container anyway this isn&#39;t as odd as it sounds.</li>
<li>We&#39;re just demonstrating files here, but if we change our manifest and rerun the puppet container then we change the config files. But depending on the application it  won&#39;t pick that up unless we restart it or create a new container.</li>
</ul>

<p>Given enough time I may try build a reference implementation using this approach, anyone with ideas about that let me know.</p>

<p>This post was inspired by a conversation with <a href="https://twitter.com/kelseyhightower">Kelsey</a> and <a href="http://twitter.com/botchagalupe">John</a>, thanks guys.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page3">Older</a>
  
  
    
      <a class="pagination-item newer" href="/">Newer</a>
    
  
</div>
    </div>

  </body>
</html>
