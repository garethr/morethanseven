<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      A template for Puppet modules &middot; More than seven
    
  </title>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-435455-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
   <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=morethansevennet" id="_carbonads_js"></script>

   <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          More than seven
        </a>
      </h1>
      <p class="lead">Writing about code mainly. Occasional other topics. Made by <a href="https://twitter.com/garethr">@garethr</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">A template for Puppet modules</h1>
  <span class="post-date">05 Feb 2014</span>
  <p>A little while ago I published a <a href="https://github.com/garethr/puppet-module-skeleton">template writing your own puppet modules</a>. It&#39;s
very opinionated but comes out of the box with lots of the tools you
eventually find and add to your tool box. I&#39;m posting this as it came
up at the recent <a href="http://cfgmgmtcamp.eu">Configuration Management Camp</a>
and after discussing it I realised I hadn&#39;t actually wrote anything
about it anywhere.</p>

<h2>What do you get?</h2>

<ul>
<li>A simple install, config, service class pattern</li>
<li>Unit tests with <a href="https://github.com/rodjek/rspec-puppet">rspec-puppet</a></li>
<li>Rake tasks for <a href="https://github.com/rodjek/puppet-lint">linting</a> and <a href="https://github.com/gds-operations/puppet-syntax">syntax checking</a></li>
<li>Integration tests using <a href="https://github.com/puppetlabs/beaker">Beaker</a></li>
<li>A Modulefile to provide Forge metadata</li>
<li>Command line tools to upload to the Forge with <a href="https://github.com/maestrodev/puppet-blacksmith">blacksmith</a></li>
<li>A README based on the Puppetlabs documentation standards</li>
<li><a href="https://travis-ci.org">Travis CI</a> configuration based on the official
Puppetlabs support matrix</li>
<li>A Guardfile which can run all the tests when you change manifests</li>
</ul>

<p>Obviously you can choose not to use parts of this, or even delete
aspects, but I find that approach much quicker than starting from scratch
or copying files from previous modules and changing names.</p>

<h2>How can I use it?</h2>

<p>Simple. The following will install the module skeleton to
<code>~/.puppet/var/puppet-module/skeleton</code>. This turns out to be picked up
by the Puppet module tool.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">git clone https://github.com/garethr/puppet-module-skeleton 
<span class="nb">cd </span>puppet-module-skeleton
find skeleton -type f <span class="p">|</span> git checkout-index --stdin --force --prefix<span class="o">=</span><span class="s2">&quot;$HOME/.puppet/var/puppet-module/&quot;</span> --
</code></pre></div>
<p>With that in place you can then just run the following to create a new
module, where puppet-ntp is the name of our new module.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">puppet module generate puppet-ntp
</code></pre></div>
<p>We use <code>puppet module</code> like this rather than just copying the files
because otherwise you would have to rename everything from class names
to test assertions. The skeleton actually contains erb templates in
places, and running <code>puppet module generate</code> results in the module name
being available to those templates.</p>

<h2>Now what?</h2>

<p>Assuming you have run the above commands you should have a folder called
<code>puppet-ntp</code> in your current directory. <code>cd</code> into that and then install
the dependencies:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">bundle install
</code></pre></div>
<p><a href="http://bundler.io/">Bundler </a>is a dependency manager for Ruby. If you
don&#39;t already have it installed you should be able to do so with the
following:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">gem install bundler
</code></pre></div>
<p>Now you have the dependencies why not run the full test suite? This
checks syntax, lints the Puppet code and runs the unit tests.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">bundle <span class="nb">exec </span>rake <span class="nb">test</span>
</code></pre></div>
<p>Unit tests give fast feedback and help make sure the code you write is
going to do what you intend, but they aren&#39;t actually applying the
manifests to a real machine. For that you want an integration test.
You&#39;ll need <a href="http://vagrantup.com">Vagrant</a> installed for this next
step. Lets run those as well with:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">bundle <span class="nb">exec </span>rspec spec/acceptance
</code></pre></div>
<p>This will take a while, especially the first time. This uses Beaker to
download a virtual machine from Puppetlabs (if you don&#39;t already have
it) and then brings up a new machine, applies a simple manifest, runs
the acceptance tests and then destroys the machine.</p>

<p>The <code>CONTRIBUTING.md</code> file has more information for running the test
suite.</p>

<h2>What&#39;s new?</h2>

<p>I&#39;ve recently added a <a href="https://github.com/guard/guard">Guardfile</a> to
help with testing. You can run this with:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">bundle <span class="nb">exec </span>guard
</code></pre></div>
<p>Now in a separate tab or pane make a change to any of the manifests. The
tests should run automatically in the tab or pane where guard is
running.</p>

<h2>Can you add this new tool?</h2>

<p>Probably. Although I started the repo a few other people have
contributed code or made improvements already. Just sent a pull request
or open an issue.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/work/gds/2014/07/20/leaving-gds-never-easy/">
            Leaving GDS never easy
            <small>20 Jul 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/security/2014/06/23/using-owasp-zap-from-the-command-line/">
            Using OWASP ZAP from the command line
            <small>23 Jun 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/consul/2014/04/25/consul/">
            Consul, DNS and Dnsmasq
            <small>25 Apr 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
