<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Fabric, Django, Git, Apache, mod_wsgi, virtualenv and pip deployment &middot; More than seven
    
  </title>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-435455-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
   <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=morethansevennet" id="_carbonads_js"></script>

   <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          More than seven
        </a>
      </h1>
      <p class="lead">Writing about code. Occasional other topics. Made by <a href="https://twitter.com/garethr">@garethr</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Fabric, Django, Git, Apache, mod_wsgi, virtualenv and pip deployment</h1>
  <span class="post-date">27 Jul 2009</span>
  <p>I&#8217;ve been playing with automating Django deployments again, this time using <a href="http://fabfile.org/">Fabric</a>. I found a number of examples on the web but non of them quite fit the bill for me. I don&#8217;t like serving directly from a repository, I like to have either a package or tar I can use to say &#8220;that is what went to the server&#8221;. I also like having a quick rollback command as well as being able to deploy a particular version of the code when the need arises. I also wanted to go from a clean ubuntu install (plus <span class="caps">SSH</span>) to a running Django application in one command from the local development machine. The Apache side of things is nicely documented in <a href="http://gist.github.com/106077">this Gist</a> which made a good starting point.</p>
<p>I&#8217;m still missing a few things in this setup mind and at the moment you still have to setup your local machine yourself. I&#8217;m probably going to create a paster template and another fabfile to do that I think. The instructions are a little rough as well at the moment and I&#8217;ve left the database out of it as everyone has there own preference.</p>
<p>This particular fabric file makes setting up and deploying a django application much easier, but it does make a few assumptions. Namely that you&#8217;re using Git, Apache and mod_wsgi and your using Debian or Ubuntu. Also you should have  Django installed on your local machine and <span class="caps">SSH</span> installed on both the local machine and any servers you want to deploy to.</p>
<p><em>note that I&#8217;ve used the name project_name throughout this example. Replace this with whatever your project is called.</em></p>
<p>First step is to create your project locally:</p>
<pre>mkdir project_name
cd project_name
django-admin.py startproject project_name</pre>
<p>Now add a requirements file so pip knows to install Django. You&#8217;ll probably add other required modules in here later. Creat a file called requirements.txt and save it at the top level with the following contents:</p>
<pre>Django</pre>
<p>Then save this fabfile.py file in the top level directory which should give you:</p>
<pre>project_name
    fabfile.py
    requirements.txt
    project_name
        __init__.py
        manage.py
        settings.py
        urls.py</pre>
<p>You&#8217;ll need a <span class="caps">WSGI</span> file called project_name.wsgi, where project_name  is the name you gave to your django project. It will probably look like the following, depending on your specific paths and the location of your settings module</p>
<pre>import os
import sys
# put the Django project on sys.path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), "../")))
os.environ["DJANGO_SETTINGS_MODULE"] = "project_name.settings"
from django.core.handlers.wsgi import WSGIHandler
application = WSGIHandler()</pre>
<p>Last but not least you&#8217;ll want a virtualhost file for apache which looks  something like the following. Save this as project_name in the inner directory. You&#8217;ll want to change /path/to/project_name/ to the location on the remote server you intent to deploy to.</p>
<pre>&lt;VirtualHost *:80&gt;
        WSGIDaemonProcess project_name-production user=project_name group=project_name threads=10 python-path=/path/to/project_name/lib/python2.6/site-packages
        WSGIProcessGroup project_name-production
        WSGIScriptAlias / /path/to/project_name/releases/current/project_name/project_name.wsgi
        &lt;Directory /path/to/project_name/releases/current/project_name&gt;
            Order deny,allow
            Allow from all
        &lt;/Directory&gt;
        ErrorLog /var/log/apache2/error.log
        LogLevel warn
        CustomLog /var/log/apache2/access.log combined
&lt;/VirtualHost&gt;</pre>
<p>Now create a file called .gitignore, containing the following. This prevents the compiled python code being included in the repository and the archive we use for deployment.</p>
<pre>*.pyc</pre>
<p>You should now be ready to initialise a git repository in the top level project_name directory.</p>
<pre>git init
git add .gitignore project_name
git commit -m "Initial commit"</pre>
<p>All of that should leave you with</p>
<pre>project_name
    .git
    .gitignore
    requirements.txt
    fabfile.py
    project_name
        __init__.py
        project_name
        project_name.wsgi
        manage.py
        settings.py
        urls.py</pre>
<p>In reality you might prefer to keep your wsgi files and virtual host files elsewhere. The fabfile has a variable (config.virtualhost_path) for this case.  You&#8217;ll also want to set the hosts that you intend to deploy to (config.hosts) as well as the user (config.user).</p>
<p>The first task we&#8217;re interested in is called setup. It installs all the  required software on the remote machine, then deploys your code and restarts the webserver.</p>
<pre>fab local setup</pre>
<p>After you&#8217;ve made a few changes and commit them to the master Git branch you can run to deply the changes.</p>
<pre>fab local deploy</pre>
<p>If something is wrong then you can rollback to the previous version.</p>
<pre>fab local rollback</pre>
<p>Note that this only allows you to rollback to the release immediately before the latest one. If you want to pick a arbitrary release then you can use the following, where 20090727170527 is a timestamp for an existing release.</p>
<pre>fab local deploy_version:20090727170527</pre>
<p>If you want to ensure your tests run before you make a deployment then you can do the following.</p>
<pre>fab local test deploy</pre>
<p>The actual fabfile looks like this. I&#8217;ve uploaded a <a href="http://gist.github.com/156623">Gist of it</a>, along with the docs, so if you want to improve it please clone it.</p>
<pre># globals
config.project_name = 'project_name'
# environments
def local():
    "Use the local virtual server"
    config.hosts = ['172.16.142.130']
    config.path = '/path/to/project_name'
    config.user = 'garethr'
    config.virtualhost_path = "/"
# tasks
def test():
    "Run the test suite and bail out if it fails"
    local("cd $(project_name); python manage.py test", fail="abort")
def setup():
    """
    Setup a fresh virtualenv as well as a few useful directories, then run
    a full deployment
    """
    require('hosts', provided_by=[local])
    require('path')
    sudo('aptitude install -y python-setuptools')
    sudo('easy_install pip')
    sudo('pip install virtualenv')
    sudo('aptitude install -y apache2')
    sudo('aptitude install -y libapache2-mod-wsgi')
    # we want rid of the defult apache config
    sudo('cd /etc/apache2/sites-available/; a2dissite default;')
    run('mkdir -p $(path); cd $(path); virtualenv .;')
    run('cd $(path); mkdir releases; mkdir shared; mkdir packages;', fail='ignore')
    deploy()
def deploy():
    """
    Deploy the latest version of the site to the servers, install any
    required third party modules, install the virtual host and 
    then restart the webserver
    """
    require('hosts', provided_by=[local])
    require('path')
    import time
    config.release = time.strftime('%Y%m%d%H%M%S')
    upload_tar_from_git()
    install_requirements()
    install_site()
    symlink_current_release()
    migrate()
    restart_webserver()
def deploy_version(version):
    "Specify a specific version to be made live"
    require('hosts', provided_by=[local])
    require('path')
    config.version = version
    run('cd $(path); rm releases/previous; mv releases/current releases/previous;')
    run('cd $(path); ln -s $(version) releases/current')
    restart_webserver()
def rollback():
    """
    Limited rollback capability. Simple loads the previously current
    version of the code. Rolling back again will swap between the two.
    """
    require('hosts', provided_by=[local])
    require('path')
    run('cd $(path); mv releases/current releases/_previous;')
    run('cd $(path); mv releases/previous releases/current;')
    run('cd $(path); mv releases/_previous releases/previous;')
    restart_webserver()    
# Helpers. These are called by other functions rather than directly
def upload_tar_from_git():
    require('release', provided_by=[deploy, setup])
    "Create an archive from the current Git master branch and upload it"
    local('git archive --format=tar master | gzip &gt; $(release).tar.gz')
    run('mkdir $(path)/releases/$(release)')
    put('$(release).tar.gz', '$(path)/packages/')
    run('cd $(path)/releases/$(release) &amp;&amp; tar zxf ../../packages/$(release).tar.gz')
    local('rm $(release).tar.gz')
def install_site():
    "Add the virtualhost file to apache"
    require('release', provided_by=[deploy, setup])
    sudo('cd $(path)/releases/$(release); cp $(project_name)$(virtualhost_path)$(project_name) /etc/apache2/sites-available/')
    sudo('cd /etc/apache2/sites-available/; a2ensite $(project_name)') 
def install_requirements():
    "Install the required packages from the requirements file using pip"
    require('release', provided_by=[deploy, setup])
    run('cd $(path); pip install -E . -r ./releases/$(release)/requirements.txt')
def symlink_current_release():
    "Symlink our current release"
    require('release', provided_by=[deploy, setup])
    run('cd $(path); rm releases/previous; mv releases/current releases/previous;', fail='ignore')
    run('cd $(path); ln -s $(release) releases/current')
def migrate():
    "Update the database"
    require('project_name')
    run('cd $(path)/releases/current/$(project_name);  ../../../bin/python manage.py syncdb --noinput')
def restart_webserver():
    "Restart the web server"
    sudo('/etc/init.d/apache2 restart')
</pre>
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/12/27/operations-more-than-systems-administration/">
            Operations is more than just Systems Administration
            <small>27 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/04/provisioning-droplets-with-puppet/">
            Provisioning droplets with Puppet
            <small>04 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/09/20/security-implications-of-unikernels/">
            Some Security Implication of Unikernels
            <small>20 Sep 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
